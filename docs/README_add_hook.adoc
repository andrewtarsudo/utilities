= Руководство для add_hook.py
:experimental:
:icons: font
:source-highlighter: rouge
:imagesdir: images
:figure-caption: Рисунок
:stylesdir: ../css
:stylesheet: default.css
:nofooter:
:toc: auto
:toc-title: Содержание

== Описание

В `git` существует возможность добавлять скрипты, которые будут выполняться на определенных этапах внесения изменений в проект:

* `pre-commit`
* `prepare-commit-msg`
* `commit-msg`
* `post-commit`
* `pre-rebase`
* `post-checkout`
* `post-merge`
* `pre-push`

Скрипт добавляет хук `pre-commit`, проверяющий все файлы `PDF_*.yml` в проекте для git, если они существуют, и не позволяющий выполнить `git commit`, если в YAML-файле указаны не существующие ссылки на элементы в директории `content/common/`.

[source,shell]
----
$ py <path/to/add_hook.py> [ -h/--help | -v/--version ] <PROJECT_ROOT>
----

.Пример
[source,shell]
----
$ py .\\add_hook.py ..\\SigFW
$ python ..\\scripts\\scripts\\add_hook.py .\\Protei_MME
----

Если все `PDF_*.yml` корректны, то `commit` успешно выполнится (если нет других проблем). +
Если хотя бы один `PDF_*.yml` не корректен, то `commit` не выполнится, а в корень проекта добавится файл
`inspect_yaml_PDF_*\_yml.log`. +
В лог-файле приводятся все указанные в `PDF_*.yml` ссылки вместе с их статусами.

include::partials/check_yml_sample.adoc[]

== Для чего нужно?

Ввиду того, что генерация PDF осуществляется целой партией, bundle, то ошибка с одним проектом ведет к отбою обновления всех других. +
Таковые случаи происходят довольно часто, и у практически всех сотрудников отдела время от времени. +
На данный момент при ошибке сборки проект временно отключается и подключается обратно вручную. +
Поэтому предпочтительно пресечь ошибку, чем исправлять ее по факту.

=== Что делает скрипт?

. Проверяет наличие файла link:../scripts/inspect_yaml.py[inspect_yaml.py] на устройстве.
. Если файл не найден, то загружает его с репозитория git.
. Проверяет наличие директории `PROJECT_ROOT`, указанной в командной строке.
. Если директория `PROJECT_ROOT` не найдена, то делает запись в log-файл `add_hook.log` и завершает работу с ошибкой.
. Проверяет наличие папки `PROJECT_ROOT/.git` в указанной директории.
. Если папка `PROJECT_ROOT/.git` не найдена, то делает запись в log-файл `add_hook.log` и завершает работу с ошибкой.
. Создает файл `PROJECT_ROOT/.git/hooks/pre-commit`.
. Записывает в файл bash-скрипт для вызова link:../scripts/inspect_yaml.py[inspect_yaml.py].
. Создает файл `PROJECT_ROOT/.pre-commit-config.yaml`.
. Записывает в файл параметры конфигурации запуска хуков.
. Если все выполнилось успешно, то удаляет пустой log-файл `add_hook.log`, создаваемый в текущей директории, откуда вызван скрипт.

=== И что дальше?

Далее перед каждой попыткой внести изменения с помощью `git commit` будет запускаться скрипт, который проверяет наличие всех файлов по ссылкам из `PDF_*.yml`.

Если в YAML-файле присутствуют некорректные ссылки, то `git commit` будет отклонен, а в log-файл `PROJECT_ROOT/inspect_yaml_PDF_*_yaml.log` будет записан вывод скрипта после проверки.

Если с YAML-файлом все хорошо, то никаких более изменений в стандартный порядок вещей не вносится.

== Как запустить?

Запускается так же, как и любые другие скрипты:

[source,shell]
----
$ py <path/to/add_hook.py> <OPTIONS> // <1> <2>
----

<1> path/to/add_hook.py -- путь до скрипта `add_hook.py`
<2> OPTIONS -- опции скрипта

=== Опции скрипта

NOTE: Здесь предполагается, что скрипт находится в директории, откуда запускается, +
т.е. `<path/to/add_hook.py>` -> `add_hook.py`.

[source,console]
----
Использование: py add_hook.py [ -h/--help | -v/--version ] PROJECT_ROOT

Добавление хука git pre-commit

Обязательные параметры:
  project_root   Путь до проекта git. Может быть как абсолютным, так и относительным.

Опциональные:
  -v, --version  Показать версию скрипта и завершить работу
  -h, --help     Показать справку и завершить работу
----

=== Как использовать?

Поэтому предлагается следующее решение как самое простое:

. Загрузить скрипт по https://gitlab.com/tech_writers_protei/scripts/-/raw/main/scripts/add_hook.py[ссылке].
. Перенести его в ту же директорию, где находятся все проекты `PycharmProjects` или `IdeaProjects`.
+
NOTE: Как правило, это директория `С:\Users\<login>\`.
+
. При необходимости добавить хук в проект, воспользоваться встроенной консолью IDE.
+
.Иконка консоли
image::find_console.png[align="center",width=960]
+
.Консоль в IDE
image::console_ide.png[align="center",width=960]
+
. Перейти в директорию проекта, если текущее местоположение от него отличается, с помощью команды `cd`.
. В консоли указать команду `py ..\add_hook.py .`.

TIP: Чтобы удобно и быстро получить путь до файла, можно выполнить следующие шаги:

include::partials/get_path.adoc[]
