# -*- coding: utf-8 -*-

if __name__ == '__main__':
    from os import execv
    from pathlib import Path
    from time import sleep

    from click.termui import echo, pause

    _old_file: str = r${old_file}
    new_file: str = r${new_file}
    args: list[str] = ${args}
    shell: str = r${shell}

    old_file: Path = Path(_old_file).expanduser()
    new_file: Path = Path(new_file).expanduser()

    sleep(5.0)
    break_flag: bool = False
    attempts: int = 3

    while not break_flag and attempts > 0:
        try:
            old_file.unlink(missing_ok=True)

        except PermissionError:
            sleep(5.0)
            attempts -= 1

        else:
            break_flag: bool = True

    if attempts <= 0 and not break_flag:
        echo(
            "Не удалось автоматически заменить старый exe-файл на новый ..."
            "\nРекомендуется заменить его вручную.")
        pause(f"Новый файл находится по пути: {new_file}\nФайл для замены: {_old_file}")

    else:
        file: Path = new_file.rename(old_file)
        file.chmod(0o775, follow_symlinks=True)

        echo("Исполняемый файл обновлен. Перезапуск файла...\n")
        sleep(2.5)

        echo(f"{shell=}\n{args=}")
        execv(shell, args)
